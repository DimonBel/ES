# Документация класса App

Класс `App` реализует систему контроля доступа с клавиатуры с использованием LCD дисплея, светодиодов и возможностью программирования нового пароля.

---

## Конструктор

### `App::App(Keypad &keypad, LcdI2c &lcd, Led &ledGreen, Led &ledRed, Led &ledProgramming)`

**Назначение:** Инициализация объекта приложения

**Параметры:**
- `keypad` - ссылка на объект клавиатуры
- `lcd` - ссылка на объект LCD дисплея
- `ledGreen` - ссылка на зелёный светодиод (успешный доступ)
- `ledRed` - ссылка на красный светодиод (отказ в доступе)
- `ledProgramming` - ссылка на светодиод режима программирования

**Как работает:**
1. Сохраняет ссылки на все переданные компоненты в приватные переменные
2. Обнуляет массивы `_inputCode` и `_newCode` с помощью `memset()`
3. Устанавливает начальную позицию ввода `_inputPos = 0`
4. Выключает режим программирования `_programmingMode = false`
5. Устанавливает позицию нового кода `_newCodePos = 0`
6. Устанавливает пароль по умолчанию "1234" в `_correctCode`

---

## Публичные методы

### `void App::begin()`

**Назначение:** Инициализация всех компонентов приложения

**Как работает:**
1. Вызывает `begin()` для клавиатуры - инициализирует пины клавиатуры
2. Вызывает `begin()` для LCD дисплея - устанавливает связь с дисплеем по I2C
3. Вызывает `begin()` для всех трёх светодиодов (зелёный, красный, программирования) - настраивает пины как OUTPUT
4. Отображает приветственный экран через `displayWelcome()`

---

### `void App::run()`

**Назначение:** Основной цикл обработки нажатий клавиш

**Как работает:**
1. Считывает нажатую клавишу с помощью `_keypad.getKey()`
2. Если клавиша была нажата (не равна `'\0'`):
   - Если активен режим программирования → вызывает `processProgrammingInput(key)`
   - Если обычный режим → вызывает `processInput(key)`
3. Если клавиша не нажата - ничего не делает

**Примечание:** Этот метод должен вызываться постоянно в главном цикле `loop()`

---

## Приватные методы - Общие

### `void App::clearInput()`

**Назначение:** Очистка введённого кода

**Как работает:**
1. Обнуляет массив `_inputCode` с помощью `memset()`
2. Сбрасывает позицию ввода `_inputPos = 0`

---

### `void App::displayWelcome()`

**Назначение:** Отображение приветственного экрана

**Как работает:**
1. Очищает LCD дисплей и ждёт 200мс для стабилизации
2. Устанавливает курсор в позицию (0, 0) - первая строка
3. Выводит текст "Enter Code:"
4. Устанавливает курсор в позицию (0, 1) - вторая строка
5. Выводит "[    ]" - визуальное поле для 4 символов
6. Выключает оба светодиода (зелёный и красный)
7. Выводит отладочное сообщение в Serial монитор

**Задержки:** Между операциями добавлены небольшие задержки (50-100мс) для стабильной работы I2C связи с LCD

---

## Приватные методы - Обработка обычного режима

### `void App::processInput(char key)`

**Назначение:** Обработка нажатий клавиш в обычном режиме

**Параметры:**
- `key` - символ нажатой клавиши

**Как работает:**

1. **Логирование:** Выводит нажатую клавишу в Serial монитор

2. **Вход в режим программирования:** Если нажата клавиша 'D' (`PROGRAM_KEY`) и позиция ввода = 0 (на приветственном экране):
   - Вызывает `enterProgrammingMode()`
   - Завершает обработку

3. **Очистка ввода:** Если нажата клавиша '*' (`CLEAR_KEY`):
   - Вызывает `clearInput()`
   - Отображает приветственный экран
   - Завершает обработку

4. **Подтверждение кода:** Если нажата клавиша '#' (`ENTER_KEY`):
   - Проверяет, что был введён хотя бы один символ (`_inputPos > 0`)
   - Добавляет нулевой байт в конец строки
   - Логирует введённый код
   - Вызывает `verifyCode()` для проверки
   - В зависимости от результата вызывает `handleValidCode()` или `handleInvalidCode()`
   - Ждёт 3 секунды
   - Очищает ввод и возвращается на приветственный экран

5. **Ввод символов:** Если нажата цифра (0-9) или буква A, B, C:
   - Проверяет, что ещё не введено 4 символа (`_inputPos < CODE_LENGTH`)
   - Добавляет символ в `_inputCode` на текущую позицию
   - Увеличивает `_inputPos`
   - Обновляет дисплей, показывая звёздочки (*) вместо введённых символов

---

### `bool App::verifyCode()`

**Назначение:** Проверка правильности введённого кода

**Возвращает:** 
- `true` - если код совпадает с `_correctCode`
- `false` - если код не совпадает

**Как работает:**
- Сравнивает строку `_inputCode` со строкой `_correctCode` с помощью функции `strcmp()`
- `strcmp()` возвращает 0 при полном совпадении строк

---

### `void App::handleValidCode()`

**Назначение:** Обработка правильного кода (доступ разрешён)

**Как работает:**
1. Выводит отладочные сообщения об успешной проверке в Serial
2. Очищает дисплей
3. Отображает на первой строке: "ACCESS GRANTED!"
4. Отображает на второй строке: "Door Unlocked"
5. Логирует состояние зелёного LED до включения
6. **Включает зелёный светодиод** (`_ledGreen.on()`)
7. Логирует состояние после включения
8. Выключает красный светодиод
9. **Держит зелёный LED включённым 5 секунд** (`delay(5000)`)
10. Выключает зелёный светодиод

**Визуальная индикация:** Зелёный LED горит 5 секунд - имитация разблокировки двери

---

### `void App::handleInvalidCode()`

**Назначение:** Обработка неправильного кода (доступ запрещён)

**Как работает:**
1. Выводит сообщение об ошибке в Serial
2. Очищает дисплей
3. Отображает на первой строке: "ACCESS DENIED!"
4. Отображает на второй строке: "Wrong Code"
5. Включает красный светодиод
6. Выключает зелёный светодиод
7. **Мигает красным LED 5 раз:** цикл с чередованием включения/выключения (150мс выкл, 150мс вкл)
8. Выключает красный светодиод в конце

**Визуальная индикация:** Красный LED мигает 5 раз - сигнализация об ошибке доступа

---

## Приватные методы - Режим программирования

### `void App::enterProgrammingMode()`

**Назначение:** Вход в режим программирования нового пароля

**Как работает:**
1. Выводит отладочные сообщения о входе в режим программирования
2. Устанавливает флаг `_programmingMode = true`
3. Сбрасывает позицию нового кода `_newCodePos = 0`
4. Очищает массив `_newCode`
5. **Включает LED программирования** (pin 3)
6. Очищает дисплей
7. Отображает на первой строке: "PROG MODE"
8. Отображает на второй строке: "New Pass [    ]"

**Активация:** Вызывается нажатием клавиши 'D' на приветственном экране

---

### `void App::processProgrammingInput(char key)`

**Назначение:** Обработка нажатий клавиш в режиме программирования

**Параметры:**
- `key` - символ нажатой клавиши

**Как работает:**

1. **Логирование:** Выводит нажатую клавишу в Serial с префиксом "[PROG-INPUT]"

2. **Отмена программирования:** Если нажата клавиша '*' (`CLEAR_KEY`):
   - Выводит сообщение об отмене
   - Сбрасывает флаг `_programmingMode = false`
   - Очищает данные нового кода
   - **Выключает LED программирования**
   - Возвращается на приветственный экран

3. **Подтверждение нового пароля:** Если нажата клавиша '#' (`ENTER_KEY`):
   - Проверяет, что введено ровно 4 цифры (`_newCodePos == CODE_LENGTH`)
   - Если да: добавляет нулевой байт и вызывает `confirmNewCode()`
   - Если нет: выводит сообщение о необходимости ввести 4 цифры

4. **Ввод цифр:** Если нажата цифра (0-9):
   - Проверяет, что ещё не введено 4 символа
   - Добавляет цифру в `_newCode`
   - Увеличивает `_newCodePos`
   - Обновляет дисплей, показывая звёздочки (*) для введённых символов

**Ограничение:** В режиме программирования принимаются **только цифры** (буквы A, B, C игнорируются)

---

### `void App::confirmNewCode()`

**Назначение:** Сохранение нового пароля и выход из режима программирования

**Как работает:**
1. Логирует новый пароль в Serial монитор
2. **Копирует новый пароль** из `_newCode` в `_correctCode` - теперь это активный пароль!
3. Очищает дисплей
4. Отображает на первой строке: "PASSWORD SAVED"
5. Отображает на второй строке: "New: " + новый пароль (например, "New: 5678")
6. **Визуальное подтверждение:** Зелёный LED мигает дважды:
   - Включить 300мс → Выключить 200мс → Включить 300мс → Выключить
7. Ждёт 2 секунды для чтения сообщения
8. Сбрасывает режим программирования (`_programmingMode = false`)
9. Очищает данные нового кода
10. **Выключает LED программирования**
11. Возвращается на приветственный экран

**Важно:** После выполнения этой функции система будет использовать новый пароль для входа!

---

## Константы класса

- **`CODE_LENGTH = 4`** - длина пароля (4 символа)
- **`CLEAR_KEY = '*'`** - клавиша отмены/очистки
- **`ENTER_KEY = '#'`** - клавиша подтверждения
- **`PROGRAM_KEY = 'D'`** - клавиша входа в режим программирования

---

## Переменные состояния

### Обычный режим:
- **`_inputCode[5]`** - массив для хранения введённого кода (4 символа + '\0')
- **`_inputPos`** - текущая позиция ввода (0-4)

### Режим программирования:
- **`_programmingMode`** - флаг активности режима программирования
- **`_newCode[5]`** - массив для нового пароля (4 символа + '\0')
- **`_newCodePos`** - текущая позиция ввода нового пароля (0-4)

### Система:
- **`_correctCode[5]`** - текущий активный пароль (изначально "1234")

---

## Блок-схема работы приложения

```
┌─────────────────┐
│   begin()       │ ← Инициализация при запуске
└────────┬────────┘
         │
         v
┌─────────────────┐
│ displayWelcome()│ ← Приветственный экран
└────────┬────────┘
         │
         v
┌─────────────────┐
│     run()       │ ◄──────┐ Главный цикл (loop)
└────────┬────────┘        │
         │                 │
         v                 │
    [Клавиша?] ────Нет────┘
         │
        Да
         │
    ┌────┴────┐
    │         │
Прогр.?    Обычный
режим      режим
    │         │
    v         v
processProg processInput
Input()       ()
    │         │
    └────┬────┘
         │
    [Обработка]
         │
         v
    [Результат]
```

---

## Сценарии использования

### Сценарий 1: Успешный вход
1. Пользователь видит "Enter Code: [    ]"
2. Вводит "1234" (по умолчанию)
3. Нажимает '#'
4. Видит "ACCESS GRANTED! Door Unlocked"
5. Зелёный LED горит 5 секунд
6. Возврат на приветственный экран

### Сценарий 2: Неудачный вход
1. Пользователь видит "Enter Code: [    ]"
2. Вводит неправильный код, например "9999"
3. Нажимает '#'
4. Видит "ACCESS DENIED! Wrong Code"
5. Красный LED мигает 5 раз
6. Через 3 секунды возврат на приветственный экран

### Сценарий 3: Изменение пароля
1. Пользователь нажимает 'D' на приветственном экране
2. Видит "PROG MODE New Pass [    ]"
3. LED программирования (pin 3) включается
4. Вводит новый пароль, например "5678"
5. Нажимает '#'
6. Видит "PASSWORD SAVED New: 5678"
7. Зелёный LED мигает дважды
8. LED программирования выключается
9. Возврат на приветственный экран
10. Теперь для входа нужен пароль "5678"

### Сценарий 4: Отмена операции
- **В обычном режиме:** Нажатие '*' очищает введённые символы
- **В режиме программирования:** Нажатие '*' отменяет программирование и возвращает на приветственный экран

---

## Технические особенности

### Работа с LCD через I2C
- Между операциями с LCD добавлены задержки (20-200мс) для стабильной работы I2C шины
- Используется метод `setCursor(col, row)` для позиционирования
- Методы `print()` и `write()` для вывода текста и символов

### Безопасность отображения пароля
- При вводе кода на экране отображаются звёздочки (*) вместо реальных символов
- Исключение: при сохранении нового пароля он показывается 2 секунды для подтверждения

### Отладка через Serial
- Все важные события логируются в Serial монитор
- Префиксы для категоризации: [APP], [KEYPAD], [CODE], [SUCCESS], [FAILURE], [PROGRAMMING], [DEBUG], [PROG-INPUT]

---

## Зависимости

Класс App требует:
- **Arduino.h** - основные функции Arduino
- **Keypad** - класс для работы с матричной клавиатурой
- **LcdI2c** - класс для работы с LCD дисплеем через I2C
- **Led** - класс для управления светодиодами

---

*Документация создана для проекта системы контроля доступа на базе Arduino*
